<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Josefin+Sans:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script class="next-config" data-name="main" type="application/json">{"hostname":"mrdjun.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.10.0","exturl":false,"sidebar":{"position":"left","toggle":false,"width":300,"display":"always","padding":18,"offset":12,"display_links":true,"links":{"love":"https://www.funpeak.cn/ || fa fa-diamond","gitee":"https://www.gitee.com/mrdjun/ || fa fa-skyatlas","github":"https://www.github.com/mrdjun/ || fa fa-github-alt","csdn":"https://mrdjun.blog.csdn.net/ || fa fa-codepen"}},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":true,"nav":null},"stickytabs":true,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

  <meta name="description" content="学ES？看这一篇就够了，详细介绍了mapping映射属性的配置，定义字段数据的各个类型；掌握在ES中使用DSL查询语法；索引库&#x2F;文档的CURD操作的http接口；采用实战的方式，介绍了ES的查询语法和参数值的使用。">
<meta property="og:type" content="website">
<meta property="og:title" content="Elasticsearch 常用Api">
<meta property="og:url" content="https://mrdjun.github.io/p/642dba5b.html">
<meta property="og:site_name" content="MrDJun">
<meta property="og:description" content="学ES？看这一篇就够了，详细介绍了mapping映射属性的配置，定义字段数据的各个类型；掌握在ES中使用DSL查询语法；索引库&#x2F;文档的CURD操作的http接口；采用实战的方式，介绍了ES的查询语法和参数值的使用。">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-03-12T09:28:38.000Z">
<meta property="article:modified_time" content="2025-05-05T09:13:12.415Z">
<meta property="article:author" content="MrDJun">
<meta property="article:tag" content="Elasticsearch">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://mrdjun.github.io/p/642dba5b.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://mrdjun.github.io/p/642dba5b.html","path":"p/642dba5b.html","title":"Elasticsearch 常用Api"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>
      Elasticsearch 常用Api | MrDJun
    </title>
    





    <noscript>
      <link rel="stylesheet" href="/css/noscript.css">
    </noscript>
    <script src="/js/jquery.js"></script>
    <link href="/lib/font-awesome/css/font-awesome.min.css" rel="stylesheet"/>
    <style is="theme"></style>
  </head>

  <body itemscope itemtype="http://schema.org/WebPage">
    <div class="headband"></div>

    <main class="main">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader">
        <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">MrDJun</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">mrdjun</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        🔍
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-🏠-home"><a href="/" rel="section">🏠 Home</a></li>
        <li class="menu-item menu-item-📦-archives"><a href="/archives/" rel="section">📦 Archives</a></li>
        <li class="menu-item menu-item-🔖-labels"><a href="/tags/" rel="section">🔖 Labels</a></li>
        <li class="menu-item menu-item-👬-friends"><a href="/friends/" rel="section">👬 Friends</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger">🔍 Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    🔍
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
          
  

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Contents
        </li>
        <li class="sidebar-nav-overview">
          Site Preview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#mapping%E6%98%A0%E5%B0%84%E5%B1%9E%E6%80%A7"><span class="nav-number">1.</span> <span class="nav-text">mapping映射属性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%97%E6%AE%B5%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE"><span class="nav-number">1.1.</span> <span class="nav-text">字段参数配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%97%E6%AE%B5%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="nav-number">1.2.</span> <span class="nav-text">字段数据类型</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E5%BA%93CURD"><span class="nav-number">2.</span> <span class="nav-text">索引库CURD</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%85%A8%E9%83%A8%E7%B4%A2%E5%BC%95"><span class="nav-number">2.1.</span> <span class="nav-text">查看全部索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="nav-number">2.2.</span> <span class="nav-text">创建索引库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="nav-number">2.3.</span> <span class="nav-text">查询索引库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="nav-number">2.4.</span> <span class="nav-text">删除索引库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="nav-number">2.5.</span> <span class="nav-text">修改索引库</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E6%A1%A3CRUD"><span class="nav-number">3.</span> <span class="nav-text">文档CRUD</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B0%E5%A2%9E"><span class="nav-number">3.1.</span> <span class="nav-text">新增</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2"><span class="nav-number">3.2.</span> <span class="nav-text">查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4"><span class="nav-number">3.3.</span> <span class="nav-text">删除</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9"><span class="nav-number">3.4.</span> <span class="nav-text">修改</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DSL%E6%9F%A5%E8%AF%A2%E6%96%87%E6%A1%A3"><span class="nav-number">4.</span> <span class="nav-text">DSL查询文档</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95%E7%BB%93%E6%9E%84"><span class="nav-number">4.1.</span> <span class="nav-text">查询基本语法结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E5%85%A8%E9%83%A8%E6%95%B0%E6%8D%AE"><span class="nav-number">4.2.</span> <span class="nav-text">查询全部数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bool%E7%BB%84%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="nav-number">4.3.</span> <span class="nav-text">bool组合查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%95%E6%9D%A1%E4%BB%B6%E6%9F%A5%E8%AF%A2"><span class="nav-number">4.4.</span> <span class="nav-text">单条件查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E6%9D%A1%E4%BB%B6%E6%9F%A5%E8%AF%A2"><span class="nav-number">4.5.</span> <span class="nav-text">多条件查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%AB%98%E4%BA%AE%E6%98%BE%E7%A4%BA%E6%9F%A5%E8%AF%A2%E7%BB%93%E6%9E%9C"><span class="nav-number">4.6.</span> <span class="nav-text">高亮显示查询结果</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="nav-number">4.7.</span> <span class="nav-text">聚合查询</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          
<div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <i id="btn_darkmode"></i>
    <img class="site-author-image" itemprop="image" alt="MrDJun"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">MrDJun</p>
  <div class="site-description" itemprop="description">Live with your heart,please be bold.</div>
</div>
  <div class="site-menu-wrap site-overview-item animated">
    <ur class="menu_urls">
        <li>
          <a href="/">🏠 Home</a>
        </li>
        <li>
          <a href="/archives/">📦 Archives</a>
        </li>
        <li>
          <a href="/tags/">🔖 Labels</a>
        </li>
        <li>
          <a href="/friends/">👬 Friends</a>
        </li>
        <li>
          <a class="popup-trigger" href="javascript:;">🔍
            Search
          </a>
        </li>
    </ur>
  </div>



<div class="asider-footer">
  <div id="links">
    <li>
      <a href="https://www.funpeak.cn/" target="_blank" itemprop="url" class="ignore-href">
        <i class="fa fa-diamond fa-fw"></i>
      </a>
    </li>
    <li>
      <a href="https://www.gitee.com/mrdjun/" target="_blank" itemprop="url" class="ignore-href">
        <i class="fa fa-skyatlas fa-fw"></i>
      </a>
    </li>
    <li>
      <a href="https://www.github.com/mrdjun/" target="_blank" itemprop="url" class="ignore-href">
        <i class="fa fa-github-alt fa-fw"></i>
      </a>
    </li>
    <li>
      <a href="https://mrdjun.blog.csdn.net/" target="_blank" itemprop="url" class="ignore-href">
        <i class="fa fa-codepen fa-fw"></i>
      </a>
    </li>
    
  </div>
  <div class="copyright">
  &copy; 2019 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="author" itemprop="copyrightHolder">MrDJun</span>
  </div>
  <div>
    UV&nbsp;<span class="busuanzi-value" id="busuanzi_value_site_uv" style="cursor:pointer" title="统计开始时间：2019年7月5日"></span> &nbsp;&nbsp;PV&nbsp;<span class="busuanzi-value" id="busuanzi_value_site_pv" style="cursor:pointer" title="统计开始时间：2019年7月5日"></span>
  </div>
</div>

        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


      </header>

      
  <div class="back-to-top" role="button" aria-label="Back to top">
    <span id='scrollpercent'>0</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


      <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://mrdjun.github.io/p/642dba5b.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="MrDJun">
      <meta itemprop="description" content="Live with your heart,please be bold.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MrDJun">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Elasticsearch 常用Api
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-time">
        <span class="post-meta-item-icon">
          <i class="fa fa-calendar-o"></i>
        </span>
        <span class="post-meta-item-text hidden">Posted on</span>
        <time title="Created: 2025-03-12 17:28:38" itemprop="dateCreated datePublished" datetime="2025-03-12T17:28:38+08:00">2025-03-12</time>
      </span>
    </span>

  
    <span class="post-meta-item" title="Visit count" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-laptop"></i>
      </span>
      <span class="post-meta-item-text">Visit count: </span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <html><head></head><body><h2 id="mapping映射属性"><a href="#mapping映射属性" class="headerlink" title="mapping映射属性"></a>mapping映射属性</h2><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping.html">官方文档链接</a></p>
<p><code>mapping</code>用于约束es中索引库中的文档，定义文档中的字段如何存储和索引的过程。</p>
<h3 id="字段参数配置"><a href="#字段参数配置" class="headerlink" title="字段参数配置"></a>字段参数配置</h3><h4 id="是否创建索引"><a href="#是否创建索引" class="headerlink" title="是否创建索引"></a>是否创建索引</h4><p>表示字段是否需要用于搜索。index：是否创建索引，默认为true。</p>
<h4 id="分词器"><a href="#分词器" class="headerlink" title="分词器"></a>分词器</h4><p>analyzer：使用哪个分词器。</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"mappings"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"properties"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">      <span class="attr">"name"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"text"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"fields"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">          <span class="attr">"length"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"integer"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"analyzer"</span><span class="punctuation">:</span> <span class="string">"standard"</span></span><br><span class="line">          <span class="punctuation">}</span></span><br><span class="line">        <span class="punctuation">}</span></span><br><span class="line">      <span class="punctuation">}</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="字段数据类型"><a href="#字段数据类型" class="headerlink" title="字段数据类型"></a>字段数据类型</h3><p>type：字段数据类型。每一个类型都可以作为数组使用。</p>
<h4 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h4><table>
<thead>
<tr>
<th>type</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>text</td>
<td>可分词的文本</td>
</tr>
<tr>
<td>keyword</td>
<td>精确值，不可分词，例如：品牌、链接、国家、ip地址等，存储和查询时效率较高</td>
</tr>
</tbody></table>
<h4 id="数值"><a href="#数值" class="headerlink" title="数值"></a><a target="_blank" rel="noopener" href="https://elastic.ac.cn/guide/en/elasticsearch/reference/current//number.html">数值</a></h4><table>
<thead>
<tr>
<th>type</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>long</td>
<td>带符号的 64 位整数，最小值为 <code>-2⁶³</code>，最大值为 <code>2⁶³-1</code>。</td>
</tr>
<tr>
<td>integer</td>
<td>带符号的 32 位整数，最小值为 <code>-2³¹</code>，最大值为 <code>2³¹-1</code>。</td>
</tr>
<tr>
<td>short</td>
<td>带符号的 16 位整数，最小值为 <code>-32,768</code>，最大值为 <code>32,767</code>。</td>
</tr>
<tr>
<td>byte</td>
<td>带符号的 8 位整数，最小值为 <code>-128</code>，最大值为 <code>127</code>。</td>
</tr>
<tr>
<td>double</td>
<td>双精度 64 位 IEEE 754 浮点数，限制为有限值。</td>
</tr>
<tr>
<td>float</td>
<td>单精度 32 位 IEEE 754 浮点数，限制为有限值。</td>
</tr>
<tr>
<td>half_float</td>
<td>半精度 16 位 IEEE 754 浮点数，限制为有限值。</td>
</tr>
<tr>
<td>scaled_float</td>
<td>一个浮点数，由一个固定的 <code>double</code> 比例因子缩放的 <code>long</code> 支持。通过比例因子将浮点数转换为整数存储，节省磁盘空间，适合精度要求不高的场景。</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://elastic.ac.cn/guide/en/elasticsearch/reference/current//unsigned-long.html">unsigned_long</a></td>
<td>无符号 64 位整数，最小值为 0，最大值为 2⁶⁴-1。</td>
</tr>
</tbody></table>
<h4 id="布尔"><a href="#布尔" class="headerlink" title="布尔"></a>布尔</h4><p>boolean：true / false。</p>
<h4 id="日期"><a href="#日期" class="headerlink" title="日期"></a>日期</h4><table>
<thead>
<tr>
<th>type</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>date</td>
<td>支持指定日期格式类型，例如常用的 <code>yyyy-MM-dd HH:mm:ss</code> 、<code>yyyy-MM-dd</code>等。默认的日期格式为: `strict_date_optional_time</td>
</tr>
<tr>
<td>date_nanos</td>
<td>对 <code>date</code> 数据类型的补充。<code>date_nanos</code> 数据类型以纳秒分辨率存储日期，这限制了其日期范围大约从 1970 年到 2262 年，因为日期仍然存储为自纪元以来的纳秒数的长整型。对纳秒的查询在内部会转换为对此长整型表示的范围查询，聚合和存储字段的结果会根据与该字段关联的日期格式转换回字符串。</td>
</tr>
</tbody></table>
<blockquote>
<p>使用<code>||</code>作为分隔符来让日期同时支持多种格式，会轮流尝试每一种格式，直到与之相匹配，第一种格式会被用来把毫秒值转换回字符串。</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"mappings"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"properties"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">      <span class="attr">"my_date"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"date"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"format"</span><span class="punctuation">:</span> <span class="string">"yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis"</span></span><br><span class="line">      <span class="punctuation">}</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>
</blockquote>
<p>JSON没有专门的日期(date)类型, 在ES中date类型可以表现为：</p>
<ul>
<li><p>字符串格式的日期, 比如: <code>2015-01-01</code>, <code>2015/01/01 12:10:30</code></p>
</li>
<li><p>long类型的自 epoch (1970-1-1) 以来的毫秒数</p>
</li>
<li><p>integer类型的自 epoch (1970-1-1) 以来的秒数(时间戳，timestamp)</p>
</li>
</ul>
<p>在ES内部，日期被转换为UTC格式(如果指定了时区)，并存储为long类型的自 epoch (1970-1-1) 以来的毫秒数。date总是被显示为字符串格式，即使他们在JSON文档中是long类型。</p>
<h4 id="binary"><a href="#binary" class="headerlink" title="binary"></a>binary</h4><p>二进制类型，值以Base64编码字符串的形式存储。<code>_source</code>默认不会存储该类型的值，也不可搜索；如果需要实际的存储，请设置 <code>store</code>属性为true，默认是false。</p>
<blockquote>
<ul>
<li>store：是否应存储字段值并可从 <code>_source</code> 字段单独检索。</li>
<li>doc_values：是否应以列式方式将字段存储在磁盘上，以便后续用于排序、聚合或脚本。</li>
</ul>
</blockquote>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"mappings"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"properties"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">      <span class="attr">"my_blob"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"binary"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"doc_values"</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"store"</span><span class="punctuation">:</span> <span class="keyword">false</span></span><br><span class="line">      <span class="punctuation">}</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="IP"><a href="#IP" class="headerlink" title="IP"></a><a target="_blank" rel="noopener" href="https://elastic.ac.cn/guide/en/elasticsearch/reference/current//ip.html">IP</a></h4><p>ip类型的字段只能存储ipv4或ipv6地址。</p>
<h4 id="Array"><a href="#Array" class="headerlink" title="Array"></a><a target="_blank" rel="noopener" href="https://elastic.ac.cn/guide/en/elasticsearch/reference/current//array.html">Array</a></h4><p>ES没有独立的数组类型，默认任何字段都可以包含一个或多个值，但数组中的值必须是同一种类型，例如：[“hello”,”world”]、[1,2,3]…。数组可以包含<code>null</code>值，它会被配置的 null_value 替代 或者 直接被忽略。空数组 <code>[]</code> 会被视为没有值的字段。</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"mappings"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"properties"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">      <span class="attr">"my_array"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"keyword"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"null_value"</span><span class="punctuation">:</span> <span class="string">"NULL"</span> </span><br><span class="line">      <span class="punctuation">}</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="对象"><a href="#对象" class="headerlink" title="对象"></a>对象</h4><p>Object 是type的默认值。假设定义name字段为对象类型，不需要显式定义type的属性值。</p>
<p>JSON对象示例：</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"region"</span><span class="punctuation">:</span> <span class="string">"US"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"manager"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"age"</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"name"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">      <span class="attr">"first"</span><span class="punctuation">:</span> <span class="string">"John"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"last"</span><span class="punctuation">:</span> <span class="string">"Smith"</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>在ES内部，下方示例的json对象会被作为文档，此文档被索引为简单的<strong>键值对扁平列表</strong>。</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"region"</span><span class="punctuation">:</span>             <span class="string">"US"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"manager.age"</span><span class="punctuation">:</span>        <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"manager.name.first"</span><span class="punctuation">:</span> <span class="string">"John"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"manager.name.last"</span><span class="punctuation">:</span>  <span class="string">"Smith"</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<p><code>mapping</code>声明如下：</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"mappings"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"properties"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">      <span class="attr">"region"</span><span class="punctuation">:</span> <span class="punctuation">{</span> <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"keyword"</span> <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"manager"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"properties"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">          <span class="attr">"age"</span><span class="punctuation">:</span> <span class="punctuation">{</span> <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"integer"</span> <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">"name"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"properties"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">              <span class="attr">"first"</span><span class="punctuation">:</span> <span class="punctuation">{</span> <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"text"</span> <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">"last"</span><span class="punctuation">:</span>  <span class="punctuation">{</span> <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"text"</span> <span class="punctuation">}</span></span><br><span class="line">            <span class="punctuation">}</span></span><br><span class="line">          <span class="punctuation">}</span></span><br><span class="line">        <span class="punctuation">}</span></span><br><span class="line">      <span class="punctuation">}</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>那如果对象里面嵌套数组呢？比如下面这个示例：</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"group"</span><span class="punctuation">:</span> <span class="string">"fans"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"user"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">{</span></span><br><span class="line">      <span class="attr">"first"</span><span class="punctuation">:</span> <span class="string">"张三"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"last"</span><span class="punctuation">:</span> <span class="string">"ZhangSan"</span></span><br><span class="line">    <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">{</span></span><br><span class="line">      <span class="attr">"first"</span><span class="punctuation">:</span> <span class="string">"李四"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"last"</span><span class="punctuation">:</span> <span class="string">"Lisi"</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<p>数组类型怎么扁平化？上面的文档会被ES平铺成这样：</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"group"</span> <span class="punctuation">:</span>        <span class="string">"fans"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"user.first"</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">"张三"</span><span class="punctuation">,</span> <span class="string">"李四"</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"user.last"</span> <span class="punctuation">:</span>  <span class="punctuation">[</span> <span class="string">"ZhangSan"</span><span class="punctuation">,</span> <span class="string">"Lisi"</span> <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<p>如果将查询条件设置成 <code>user.first=张三 and user.last=Lisi</code>会被查询出来吗？会！</p>
 <figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"query"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"bool"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">      <span class="attr">"must"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">{</span> <span class="attr">"match"</span><span class="punctuation">:</span> <span class="punctuation">{</span> <span class="attr">"user.first"</span><span class="punctuation">:</span> <span class="string">"张三"</span> <span class="punctuation">}</span><span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">{</span> <span class="attr">"match"</span><span class="punctuation">:</span> <span class="punctuation">{</span> <span class="attr">"user.last"</span><span class="punctuation">:</span>  <span class="string">"Lisi"</span> <span class="punctuation">}</span><span class="punctuation">}</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<p>查询结果并不符合预期，可以通过显式声明类型为<code>nested</code>来解决。</p>
<h4 id="nested"><a href="#nested" class="headerlink" title="nested"></a>nested</h4><p><code>nested</code>嵌套类型是<code>object</code>中的一个特例，可以让<code>array</code>类型的<code>Object array</code>独立索引和查询。</p>
<p>ES没有内部对象的概念，因此，ES会把具有层次结构的对象平铺成简单的<code>Key-Values</code>（键和值列表）。</p>
<p>mapping声明定义示例：</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"mappings"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"properties"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">      <span class="attr">"group"</span><span class="punctuation">:</span> <span class="punctuation">{</span>  <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"keyword"</span> <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"user"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"nested"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"properties"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">          <span class="attr">"first"</span><span class="punctuation">:</span> <span class="punctuation">{</span> <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"text"</span> <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">"last"</span><span class="punctuation">:</span> <span class="punctuation">{</span> <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"text"</span> <span class="punctuation">}</span></span><br><span class="line">        <span class="punctuation">}</span></span><br><span class="line">      <span class="punctuation">}</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="token-count"><a href="#token-count" class="headerlink" title="token_count"></a>token_count</h4><p>存储字符串值，分析并统计词的个数，实际是<code>integer</code>类型。</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"mappings"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"properties"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">      <span class="attr">"name"</span><span class="punctuation">:</span> <span class="punctuation">{</span> </span><br><span class="line">        <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"text"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"fields"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">          <span class="attr">"length"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"token_count"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"analyzer"</span><span class="punctuation">:</span> <span class="string">"standard"</span></span><br><span class="line">          <span class="punctuation">}</span></span><br><span class="line">        <span class="punctuation">}</span></span><br><span class="line">      <span class="punctuation">}</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<p>向文档中插入两条数据：</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span> <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"John Smith"</span> <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">{</span> <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"Rachel Alice Williams"</span> <span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<p>查询 <code>name</code> 字段中，分词的个数为3的文档：</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"query"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"term"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">      <span class="attr">"name.length"</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="range"><a href="#range" class="headerlink" title="range"></a>range</h4><table>
<thead>
<tr>
<th>type</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>integer_range</code></td>
<td>带符号 32 位整数的范围，最小值为 <code>-231</code>，最大值为 <code>231-1</code>。</td>
</tr>
<tr>
<td><code>float_range</code></td>
<td>单精度 32 位 IEEE 754 浮点值的范围。</td>
</tr>
<tr>
<td><code>long_range</code></td>
<td>带符号 64 位整数的范围，最小值为 <code>-263</code>，最大值为 <code>263-1</code>。</td>
</tr>
<tr>
<td><code>double_range</code></td>
<td>双精度 64 位 IEEE 754 浮点值的范围。</td>
</tr>
<tr>
<td><code>date_range</code></td>
<td><a target="_blank" rel="noopener" href="https://elastic.ac.cn/guide/en/elasticsearch/reference/current//date.html"><code>date</code></a> 值的范围。日期范围通过 <a target="_blank" rel="noopener" href="https://elastic.ac.cn/guide/en/elasticsearch/reference/current//mapping-date-format.html"><code>format</code></a> 映射参数支持各种日期格式。无论使用哪种格式，日期值都会被解析为自 Unix 纪元以来以 UTC 毫秒为单位的无符号 64 位整数。不支持包含 <code>now</code> <a target="_blank" rel="noopener" href="https://elastic.ac.cn/guide/en/elasticsearch/reference/current//common-options.html#date-math">日期数学</a> 表达式的值。</td>
</tr>
<tr>
<td><code>ip_range</code></td>
<td>支持 IPv4 或 IPv6（或混合）地址的 IP 值范围。</td>
</tr>
</tbody></table>
<p>应用示例：</p>
<figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_range</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "expected_attendees": {</span><br><span class="line">        "type": "integer_range"</span><br><span class="line">      },</span><br><span class="line">      "time_frame": {</span><br><span class="line">        "type": "date_range",</span><br><span class="line">        "format": "yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure>

<p>插入一条数据：<code>expected_attendees</code> 取值范围为<code>10 ~ 20</code>, 日期time_frame的范围是<code>2025-01-01 23:59:59 ~ 2025-05-05</code>。</p>
<figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_range/_doc/1?refresh</span><br><span class="line">{</span><br><span class="line">  "expected_attendees" : {</span><br><span class="line">    "gte" : 10,</span><br><span class="line">    "lte" : 20</span><br><span class="line">  },</span><br><span class="line">  "time_frame" : {</span><br><span class="line">    "gte" : "2025-01-01 23:59:59",</span><br><span class="line">    "lte" : "2025-05-05"</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>范围查询</p>
<ul>
<li>relation：范围查询支持 <code>within</code> 、 <code>contains</code>、<code> intersects</code>(默认)。</li>
</ul>
<figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET /my_range/_search</span><br><span class="line">{</span><br><span class="line">  "query" : {</span><br><span class="line">    "range" : {</span><br><span class="line">      "time_frame" : { </span><br><span class="line">        "gte" : "2025-01-02 23:59:59",</span><br><span class="line">        "lte" : "2025-04-01 08:00:00",</span><br><span class="line">        "relation" : "within"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="索引库CURD"><a href="#索引库CURD" class="headerlink" title="索引库CURD"></a>索引库CURD</h2><p>ES中通过restful请求操作索引库、文档。请求内容用DSL（Domain Specific Language）语句来表示。</p>
<h3 id="查看全部索引"><a href="#查看全部索引" class="headerlink" title="查看全部索引"></a>查看全部索引</h3><figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET _cat/indices?v</span><br></pre></td></tr></tbody></table></figure>

<table>
<thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>health</td>
<td>索引的健康状态，这里是 “yellow”。Elasticsearch 索引的健康状态有三种：green（绿色，健康），yellow（黄色，部分健康），red（红色，不健康）。”yellow” 状态表示索引的某些分片处于未分配状态，但主分片是可用的。</td>
</tr>
<tr>
<td>status</td>
<td>索引的状态，这里是 “open”。这表示索引处于打开状态，可以进行读取和写入操作。</td>
</tr>
<tr>
<td>index</td>
<td>索引的名称，这里是 “nginx-access-log-2023.09.13”。</td>
</tr>
<tr>
<td>uuid</td>
<td>索引的唯一标识符。</td>
</tr>
<tr>
<td>pri</td>
<td>主分片（primary shard）的数量，这里是 1 个主分片。</td>
</tr>
<tr>
<td>rep</td>
<td>副本分片（replica shard）的数量，这里也是 1 个副本分片。</td>
</tr>
<tr>
<td>docs.count</td>
<td>索引中文档的总数，这里是 20。</td>
</tr>
<tr>
<td>docs.deleted</td>
<td>索引中已删除的文档数量，这里是 0。</td>
</tr>
<tr>
<td>store.size</td>
<td>索引的存储大小，这里是 34.1KB。</td>
</tr>
<tr>
<td>pri.store.size</td>
<td>主分片的存储大小，这里也是 34.1KB。</td>
</tr>
</tbody></table>
<h3 id="创建索引库"><a href="#创建索引库" class="headerlink" title="创建索引库"></a>创建索引库</h3><figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PUT  /&lt;index&gt;</span><br><span class="line">{</span><br><span class="line">    "mappings": {</span><br><span class="line">        "properties":{</span><br><span class="line">            "字段名1": {</span><br><span class="line">                "type": "text",       // 可分词的</span><br><span class="line">                "analyzer":"ik_smart" // 指定ik_smart分词器</span><br><span class="line">            },</span><br><span class="line">            "字段名2": {</span><br><span class="line">                "type": "keyword",    // 精确值，不可分词的</span><br><span class="line">                "index": "false"</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="查询索引库"><a href="#查询索引库" class="headerlink" title="查询索引库"></a>查询索引库</h3><figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /&lt;index&gt;</span><br></pre></td></tr></tbody></table></figure>

<h3 id="删除索引库"><a href="#删除索引库" class="headerlink" title="删除索引库"></a>删除索引库</h3><figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE /&lt;index&gt;</span><br></pre></td></tr></tbody></table></figure>

<h3 id="修改索引库"><a href="#修改索引库" class="headerlink" title="修改索引库"></a>修改索引库</h3><p>索引库和mapping一但创建无法修改，支持添加新的字段，语法如下：</p>
<figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT /&lt;index&gt;/_mapping</span><br><span class="line">{</span><br><span class="line"> "properties": {</span><br><span class="line"> 	"新字段名": { ... }</span><br><span class="line"> }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="文档CRUD"><a href="#文档CRUD" class="headerlink" title="文档CRUD"></a>文档CRUD</h2><h3 id="新增"><a href="#新增" class="headerlink" title="新增"></a>新增</h3><p>如果不指定文档ID，ES会随机生成一个。</p>
<figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST /&lt;index&gt;/_doc/文档ID</span><br><span class="line">{</span><br><span class="line">	"字段1": "值",</span><br><span class="line">	"字段2": {</span><br><span class="line">		"子字段1":"值",</span><br><span class="line">		"子字段2": 0</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h3><figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /&lt;index&gt;/_doc/文档ID</span><br></pre></td></tr></tbody></table></figure>

<h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE /&lt;index&gt;/_doc/文档ID</span><br></pre></td></tr></tbody></table></figure>

<h3 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h3><p>全量修改，先删除旧文档，再添加新文档。</p>
<figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT /&lt;index&gt;/_doc/文档ID</span><br><span class="line">{</span><br><span class="line">   "字段1": "v1",</span><br><span class="line">   "字段2": "v2",</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>局部修改，修改指定字段。</p>
<figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT /&lt;index&gt;/_doc/文档ID</span><br><span class="line">{</span><br><span class="line">  "doc": {</span><br><span class="line">   "字段1": "v2"</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="DSL查询文档"><a href="#DSL查询文档" class="headerlink" title="DSL查询文档"></a>DSL查询文档</h2><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html">官方文档链接</a>。ES基于JSON的DSL（Domain Specific Language）来定义查询语法。</p>
<h3 id="查询基本语法结构"><a href="#查询基本语法结构" class="headerlink" title="查询基本语法结构"></a>查询基本语法结构</h3><p>_source：用于设置查询结果返回什么字段，类似Select语句后面指定字段。</p>
<figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /&lt;index&gt;/_search</span><br><span class="line">{</span><br><span class="line">	"from" : 0,  // 返回搜索结果的开始位置</span><br><span class="line">  	"size" : 10, // 分页大小，一次返回多少数据</span><br><span class="line">  	"_source" :[ ...需要返回的字段数组... ],</span><br><span class="line">	"query" : { ...query子句... },</span><br><span class="line">	"aggs" : { ..aggs子句..  },</span><br><span class="line">	"sort" : { ..sort子句..  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>支持一次搜索多个索引，多个索引使用逗号分隔：</p>
<figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /&lt;index1&gt;,&lt;index2&gt;/_search</span><br></pre></td></tr></tbody></table></figure>

<p>按前缀匹配索引名：</p>
<figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /&lt;index&gt;*/_search</span><br></pre></td></tr></tbody></table></figure>

<p>执行查询语句，返回的JSON结构：</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  <span class="attr">"took"</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span> <span class="comment">// 查询消耗时间，单位毫秒 </span></span><br><span class="line">  <span class="attr">"timed_out"</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span> <span class="comment">// 查询是否超时</span></span><br><span class="line">  <span class="attr">"_shards"</span> <span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="comment">// 本次查询参与的ES分片信息，查询中参与分片的总数，以及这些分片成功了多少个失败了多少个</span></span><br><span class="line">    <span class="attr">"total"</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"successful"</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"skipped"</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"failed"</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"hits"</span> <span class="punctuation">:</span> <span class="punctuation">{</span> <span class="comment">// hits字段是搜索命中的结果</span></span><br><span class="line">    <span class="attr">"total"</span> <span class="punctuation">:</span> <span class="punctuation">{</span> <span class="comment">// 匹配到的文档总数</span></span><br><span class="line">      <span class="attr">"value"</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> <span class="comment">// 找到1个文档</span></span><br><span class="line">      <span class="attr">"relation"</span> <span class="punctuation">:</span> <span class="string">"eq"</span></span><br><span class="line">    <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"max_score"</span> <span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span> <span class="comment">// 匹配到的最大分值</span></span><br><span class="line">    <span class="attr">"hits"</span> <span class="punctuation">:</span> <span class="punctuation">[</span> </span><br><span class="line">         <span class="comment">// 这里就是我们具体的搜索结果，是一个JSON数组</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<p>查询子句：</p>
<ul>
<li>query：主要用来编写类似SQL的Where语句，支持布尔查询（and/or）、IN、全文搜索、模糊匹配、范围查询（大于小于）。</li>
<li>aggs：主要用来编写统计分析语句，类似SQL的group by语句</li>
<li>sort：用来设置排序条件，类似SQL的order by语句</li>
<li>分页查询：主要通过from和size参数设置，类似MYSQL 的limit和offset语句</li>
</ul>
</blockquote>
<h3 id="查询全部数据"><a href="#查询全部数据" class="headerlink" title="查询全部数据"></a>查询全部数据</h3><p>查询所有数据，从第0条数据开始，一次返回20条数据。</p>
<figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /&lt;index&gt;/_search</span><br><span class="line">{</span><br><span class="line">  "from": 0,</span><br><span class="line">  "size": 20, </span><br><span class="line">  "query": {</span><br><span class="line">    "match_all": {}</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="bool组合查询"><a href="#bool组合查询" class="headerlink" title="bool组合查询"></a>bool组合查询</h3><p>如果需要编写类似SQL的Where语句，组合多个字段的查询条件，可以使用bool语句，类似SQL中的<code>and </code>（且）、<code>or</code> （或）。</p>
<blockquote>
<p>语法结构：</p>
<ul>
<li>must：类似SQL中的and，必须匹配条件。</li>
<li>must_not：跟must相反，必须不匹配条件。</li>
<li>should：类似SQL中or，只要匹配其中一个条件即可。</li>
</ul>
</blockquote>
<figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET /&lt;index&gt;/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "bool": {</span><br><span class="line">      "must": [</span><br><span class="line">      	 {匹配条件1},</span><br><span class="line">         {匹配条件2},</span><br><span class="line">         ...可以有N个匹配条件...</span><br><span class="line">      ],</span><br><span class="line">      "must_not": [],</span><br><span class="line">      "should": []</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>综合应用示例</strong></p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> order_v2 <span class="keyword">where</span> (order_no<span class="operator">=</span><span class="string">'2025051112091209991'</span> <span class="keyword">and</span> (shop_id<span class="operator">&gt;=</span><span class="number">10</span> <span class="keyword">and</span> shop_id<span class="operator">&lt;=</span><span class="number">200</span>)) <span class="keyword">or</span> tag <span class="keyword">in</span> (<span class="number">1</span>,<span class="number">2</span>)</span><br></pre></td></tr></tbody></table></figure>

<p>等价SQL的DSL的查询方式：</p>
<figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "bool": {</span><br><span class="line">      "should": [</span><br><span class="line">        {</span><br><span class="line">          "bool": {</span><br><span class="line">            "must": [</span><br><span class="line">              {</span><br><span class="line">                "term": {</span><br><span class="line">                  "order_no": "2025051112091209991"</span><br><span class="line">                }</span><br><span class="line">              },</span><br><span class="line">              {</span><br><span class="line">                "range": {</span><br><span class="line">                  "shop_id": {</span><br><span class="line">                    "gte": 10,</span><br><span class="line">                    "lte": 200</span><br><span class="line">                  }</span><br><span class="line">                }</span><br><span class="line">              }</span><br><span class="line">            ]</span><br><span class="line">          }</span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">          "terms": {</span><br><span class="line">            "tag": [1, 2]</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      ]</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="单条件查询"><a href="#单条件查询" class="headerlink" title="单条件查询"></a>单条件查询</h3><p>通过match实现全文搜索，将内容分词后再搜索；</p>
<p>例1，搜索 message 包含 34</p>
<figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST /&lt;index&gt;/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match": {</span><br><span class="line">      "message": "34"</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  "size": 1000</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>例2，搜索 message 包含 34 或者 包含 36</p>
<figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST /&lt;index&gt;/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match": {</span><br><span class="line">      "message": "34 36"</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  "size": 1000</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>例3，搜索 message 包含 34 并且 包含 36</p>
<figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST /&lt;index&gt;/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match": {</span><br><span class="line">      "message": {</span><br><span class="line">        "query": "34 36",</span><br><span class="line">        "operator": "and"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  "size": 1000</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>例4，搜索 message 包含 34 36 15 22 中超过 50% 以上比例的</p>
<figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST /&lt;index&gt;/_search</span><br><span class="line">{</span><br><span class="line">  "query": { </span><br><span class="line">    "match": { </span><br><span class="line">      "message": {</span><br><span class="line">        "query": "34 36 15 22",</span><br><span class="line">        "minimum_should_match": "50%"</span><br><span class="line">      }</span><br><span class="line">    } </span><br><span class="line">  },</span><br><span class="line">  "size": 1000</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>例5，使用sort对查询数据排序，并按照size返回查询的数量（desc：降序 / asc：升序）</p>
<figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET /&lt;index&gt;/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match": {</span><br><span class="line">      "title": "python elasticsearch"</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  "sort": {</span><br><span class="line">    "postDate": {</span><br><span class="line">      "order": "desc"</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  "size": 2</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="多条件查询"><a href="#多条件查询" class="headerlink" title="多条件查询"></a>多条件查询</h3><p><code>and</code>条件使用 <code>must</code>，<code>or</code> 条件使用 <code>should</code>。</p>
<p>例1，搜索Math学科<strong>并且</strong>发布时间是指定日期的数据。</p>
<figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GET /&lt;index&gt;/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "bool": {</span><br><span class="line">      "must": [</span><br><span class="line">        {</span><br><span class="line">          "match": { "class": "Math" }</span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">          "match": { "published_date": "2023-01-17T20:53:42+00:00" }</span><br><span class="line">        }</span><br><span class="line">      ]</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>例2，搜索Math学科<strong>或者</strong>发布时间是指定日期的数据。</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"query"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"bool"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">      <span class="attr">"should"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">          <span class="attr">"match"</span><span class="punctuation">:</span> <span class="punctuation">{</span> <span class="attr">"class"</span><span class="punctuation">:</span> <span class="string">"Math"</span> <span class="punctuation">}</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">          <span class="attr">"match"</span><span class="punctuation">:</span> <span class="punctuation">{</span> <span class="attr">"published_date"</span><span class="punctuation">:</span> <span class="string">"2023-01-17T20:53:42+00:00"</span> <span class="punctuation">}</span></span><br><span class="line">        <span class="punctuation">}</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<p>例3，多个条件中，至少满足2个以上。搜索包含Math学科、指定发布日期、题型是选择题的。</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"query"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"bool"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">      <span class="attr">"should"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">          <span class="attr">"match"</span><span class="punctuation">:</span> <span class="punctuation">{</span> <span class="attr">"class"</span><span class="punctuation">:</span> <span class="string">"Math"</span> <span class="punctuation">}</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">          <span class="attr">"match"</span><span class="punctuation">:</span> <span class="punctuation">{</span> <span class="attr">"published_date"</span><span class="punctuation">:</span> <span class="string">"2023-01-17T20:53:42+00:00"</span> <span class="punctuation">}</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">          <span class="attr">"match"</span><span class="punctuation">:</span> <span class="punctuation">{</span> <span class="attr">"question_type"</span><span class="punctuation">:</span> <span class="string">"choice"</span> <span class="punctuation">}</span></span><br><span class="line">        <span class="punctuation">}</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"minimum_should_match"</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<p>例4，同时使用包含和不包含的条件。搜索Math学科，但不是选择题。</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"query"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"bool"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">      <span class="attr">"must"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">          <span class="attr">"match"</span><span class="punctuation">:</span> <span class="punctuation">{</span>  <span class="attr">"class"</span><span class="punctuation">:</span> <span class="string">"Math"</span> <span class="punctuation">}</span></span><br><span class="line">        <span class="punctuation">}</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"must_not"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">          <span class="attr">"match"</span><span class="punctuation">:</span> <span class="punctuation">{</span> <span class="attr">"question_type"</span><span class="punctuation">:</span> <span class="string">"choice"</span> <span class="punctuation">}</span></span><br><span class="line">        <span class="punctuation">}</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"size"</span><span class="punctuation">:</span> <span class="number">100</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="高亮显示查询结果"><a href="#高亮显示查询结果" class="headerlink" title="高亮显示查询结果"></a>高亮显示查询结果</h3><ul>
<li><p>pre_tags：自定义标签的前半部分的html标签、属性及样式。默认标签为&lt;em&gt;</p>
</li>
<li><p>post_tags：自定义标签的后半部分样式。默认为：&lt;/em&gt;</p>
</li>
</ul>
<p>示例：</p>
<ul>
<li><p>数据部分：中国是世界上人口最多的国家</p>
</li>
<li><p>搜索词：中国</p>
</li>
</ul>
<figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET /&lt;index&gt;/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match": {</span><br><span class="line">      "remark": "中国"</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  "highlight": {</span><br><span class="line">    "pre_tags": "&lt;b class='key' style='color:red'&gt;",</span><br><span class="line">    "post_tags": "&lt;/b&gt;",</span><br><span class="line">    "fields": {</span><br><span class="line">      "remark": {}</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>搜索结果：</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"hits"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="comment">// 略</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"highlight"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"remark"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">"&lt;b class='key' style='color:red'&gt;中&lt;/b&gt;&lt;b class='key' style='color:red'&gt;国&lt;/b&gt;"</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="聚合查询"><a href="#聚合查询" class="headerlink" title="聚合查询"></a>聚合查询</h3><p>聚合查询，类似在SQL中的<code>group by</code>。</p>
<p>统计分析主要分为<strong>分组</strong>和<strong>组内聚合</strong>两个步骤。组内聚合，类似在SQL中 <code>select</code> 编写的<code>avg</code>、<code>sum</code>、<code>count</code>统计函数；</p>
<ul>
<li>对查询的数据首先进行一轮分组，可以设置分组条件，例如：新生入学，把所有的学生按专业分班，这个分班的过程就是对学生进行了分组。</li>
<li>组内聚合，就是对组内的数据进行统计，例如：计算总数、求平均值等等，接上面的例子，学生都按专业分班了，那么就可以统计每个班的学生总数， 这个统计每个班学生总数的计算，就是组内聚合计算。</li>
</ul>
<p><strong>“桶”的概念</strong></p>
<p>满足特定条件的文档的集合，叫做桶。就是一组数据的集合，对数据分组后，得到一组组的数据，就是一个个的桶。</p>
<blockquote>
<p>桶等同于组，分桶和分组是一个意思，ES使用桶代表一组相同特征的数据。</p>
</blockquote>
<p>桶聚合：指的就是先对数据进行分组，ES支持多种分组条件，例如：支持类似SQL的<code>group by</code>根据字段分组，当然ES比SQL更强大，支持更多的分组条件，以满足各种统计需求。</p>
<p><strong>“指标”的概念</strong></p>
<p>指标：对文档进行统计计算方式，又叫指标聚合。常用的指标有：<code>SUM</code>、<code>COUNT</code>、<code>MAX</code>等统计函数。</p>
<p>桶内聚合：先对数据进行分组（分桶），然后对每一个桶内的数据进行指标聚合。</p>
<p><strong>查询语法</strong></p>
<ul>
<li><strong>aggregations</strong> - 代表聚合查询语句，可以简写为<code>aggs</code>。</li>
<li><strong><aggregation_name></aggregation_name></strong> - 代表一个聚合计算的名字，可以随意命名，因为ES支持一次进行多次统计分析查询，后面需要通过这个名字在查询结果中找到我们想要的计算结果。</li>
<li><strong><aggregation_type></aggregation_type></strong> - 聚合类型，代表我们想要怎么统计数据，主要有两大类聚合类型，桶聚合和指标聚合，这两类聚合又包括多种聚合类型，例如：指标聚合：<code>sum</code>、<code>avg</code>， 桶聚合：<code>terms</code>、<code>Date histogram</code>等等。</li>
<li><strong><aggregation_body></aggregation_body></strong> - 聚合类型的参数，选择不同的聚合类型，有不同的参数。</li>
<li><strong>aggregation_name_2</strong> - 代表其他聚合计算的名字，意思就是可以一次进行多种类型的统计。</li>
</ul>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"aggregations"</span> <span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"&lt;aggregation_name&gt;"</span> <span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"&lt;aggregation_type&gt;"</span> <span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">            &lt;aggregation_body&gt;</span><br><span class="line">        <span class="punctuation">}</span></span><br><span class="line">        <span class="punctuation">[</span><span class="punctuation">,</span><span class="attr">"aggregations"</span> <span class="punctuation">:</span> <span class="punctuation">{</span> <span class="punctuation">[</span>&lt;sub_aggregation&gt;<span class="punctuation">]</span>+ <span class="punctuation">}</span> <span class="punctuation">]</span>? <span class="comment">// 嵌套聚合查询，支持多层嵌套</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line">    <span class="punctuation">[</span><span class="punctuation">,</span><span class="attr">"&lt;aggregation_name_2&gt;"</span> <span class="punctuation">:</span> <span class="punctuation">{</span> ... <span class="punctuation">}</span> <span class="punctuation">]</span>* <span class="comment">// 多个聚合查询，每个聚合查询取不同的名字</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<p><strong>应用示例</strong></p>
<p>假设存在一个order索引，存储了每一笔汽车销售订单，里面包含了汽车颜色字段color。</p>
<p>现需统计每一种汽车颜色的销量。</p>
<p>在SQL中：</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(color) <span class="keyword">from</span> <span class="keyword">order</span> <span class="keyword">group</span> <span class="keyword">by</span> color</span><br></pre></td></tr></tbody></table></figure>

<p>在ES中：</p>
<ul>
<li>size：设置size=0的意思就是，仅返回聚合查询结果，不返回普通query查询结果。</li>
<li>aggs：聚合查询语句的简写。</li>
<li>popular_colors：给聚合查询取个名字，叫做 <code>popular_colors</code>。</li>
<li>terms：聚合类型为terms,桶聚合的一种，类似SQL的group by的作用，根据字段分组，相同字段值的文档分为一组。</li>
<li>field：terms聚合类型的参数，这里需要设置分组的字段为color，根据color分组。</li>
</ul>
<figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /order/_search</span><br><span class="line">{</span><br><span class="line">    "size" : 0,</span><br><span class="line">    "aggs" : {</span><br><span class="line">        "popular_colors" : {</span><br><span class="line">            "terms" : {</span><br><span class="line">              "field" : "color"</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>查询结果：</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">...</span><br><span class="line">   <span class="attr">"hits"</span><span class="punctuation">:</span> <span class="punctuation">{</span> <span class="comment">// 因为size=0,所以query查询结果为空</span></span><br><span class="line">      <span class="attr">"hits"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span> </span><br><span class="line">   <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">"aggregations"</span><span class="punctuation">:</span> <span class="punctuation">{</span> <span class="comment">// 聚合查询结果</span></span><br><span class="line">      <span class="attr">"popular_colors"</span><span class="punctuation">:</span> <span class="punctuation">{</span> <span class="comment">// 这个就是popular_colors聚合查询的结果，这就是为什么需要给聚合查询取个名字的原因，如果有多个聚合查询，可以通过名字查找结果</span></span><br><span class="line">         <span class="attr">"buckets"</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="comment">// 因为是桶聚合，所以看到返回一个buckets数组，代表分组的统计情况，下面可以看到每一种颜色的销量情况</span></span><br><span class="line">            <span class="punctuation">{</span></span><br><span class="line">               <span class="attr">"key"</span><span class="punctuation">:</span> <span class="string">"red"</span><span class="punctuation">,</span> </span><br><span class="line">               <span class="attr">"doc_count"</span><span class="punctuation">:</span> <span class="number">4</span> <span class="comment">// 红色的汽车销量为4</span></span><br><span class="line">            <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">{</span></span><br><span class="line">               <span class="attr">"key"</span><span class="punctuation">:</span> <span class="string">"blue"</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">"doc_count"</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">            <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">{</span></span><br><span class="line">               <span class="attr">"key"</span><span class="punctuation">:</span> <span class="string">"green"</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">"doc_count"</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">            <span class="punctuation">}</span></span><br><span class="line">         <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">}</span></span><br><span class="line">   <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<p><strong>指标聚合</strong></p>
<p>类似 SQL 的统计函数，指标聚合可以单独使用，也可以跟桶聚合一起使用。常用的统计函数如下：</p>
<ul>
<li><code>Value Count</code>： 类似 SQL的<code>count</code>函数，主要用于值聚合，统计文档总数。</li>
<li><code>Cardinality</code>：类似 SQL 的<code>count(DISTINCT 字段)</code>， 统计不重复的文档总数。</li>
<li><code>Avg</code>：求平均值</li>
<li><code>Sum</code> ：求和</li>
<li><code>Max</code> ：求最大值</li>
<li><code>Min</code> ：求最小值</li>
</ul>
<p>应用示例：</p>
<figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/_search?size=0</span><br><span class="line">{</span><br><span class="line">  "aggs": {</span><br><span class="line">    "types_count": { // 聚合查询的名字，随便取个名字</span><br><span class="line">      "value_count": { // 聚合类型为：value_count</span><br><span class="line">        "field": "product_type" // 计算 product_type 这个字段值的总数</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>等价于SQL：<code>select count(type) from sales</code></p>
<p>查询结果：</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="attr">"aggregations"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"types_count"</span><span class="punctuation">:</span> <span class="punctuation">{</span> <span class="comment">// 聚合查询的名字</span></span><br><span class="line">            <span class="attr">"value"</span><span class="punctuation">:</span> <span class="number">7</span> <span class="comment">// 统计结果</span></span><br><span class="line">        <span class="punctuation">}</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<p><strong>桶聚合</strong></p>
<p>目的就是数据分组，先将数据按指定的条件分成多个组(桶)，然后对每一个组(桶)进行统计。在ES中统一使用桶（bucket）这个术语。</p>
<p>桶聚合的作用跟SQL的group by的作用是一样的，区别是ES支持更加强大的数据分组能力，SQL只能根据字段的唯一值进行分组，分组的数量跟字段的唯一值的数量相等，例如: group by 店铺id， 去掉重复的店铺ID后，有多少个店铺就有多少个分组。</p>
<p>常用的桶聚合方式：</p>
<ul>
<li>Terms： 类似SQL的group by，根据字段唯一值分组</li>
<li>Histogram：根据数值间隔分组，例如: 价格按100间隔分组，0、100、200、300等等</li>
<li>Date histogram：根据时间间隔分组，例如：按月、按天、按小时分组</li>
<li>Range：按数值范围分组，例如: 0-150一组，150-200一组，200-500一组。</li>
</ul>
<p>应用示例：</p>
<figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /order/_search?size=0</span><br><span class="line">{</span><br><span class="line">  "aggs": {</span><br><span class="line">    "shop": { // 聚合查询的名字，随便取个名字</span><br><span class="line">      "terms": { // 聚合类型为: terms</span><br><span class="line">        "field": "shop_id" // 根据shop_id字段值，分桶</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>等价于SQL：<code>select shop_id, count(*) from order group by shop_id</code></p>
<p>查询结果：</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="attr">"aggregations"</span> <span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"shop"</span> <span class="punctuation">:</span> <span class="punctuation">{</span> <span class="comment">// 聚合查询名字</span></span><br><span class="line">            <span class="attr">"buckets"</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="comment">// 桶聚合结果，下面返回各个桶的聚合结果</span></span><br><span class="line">                <span class="punctuation">{</span></span><br><span class="line">                    <span class="attr">"key"</span> <span class="punctuation">:</span> <span class="string">"1"</span><span class="punctuation">,</span> <span class="comment">// key分桶的标识，在terms聚合中，代表的就是分桶的字段值</span></span><br><span class="line">                    <span class="attr">"doc_count"</span> <span class="punctuation">:</span> <span class="number">6</span> <span class="comment">// 默认的指标聚合是统计桶内文档总数</span></span><br><span class="line">                <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">{</span></span><br><span class="line">                    <span class="attr">"key"</span> <span class="punctuation">:</span> <span class="string">"5"</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">"doc_count"</span> <span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">                <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">{</span></span><br><span class="line">                    <span class="attr">"key"</span> <span class="punctuation">:</span> <span class="string">"9"</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">"doc_count"</span> <span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">                <span class="punctuation">}</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">}</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<p><strong>多桶排序</strong></p>
<p>默认情况，ES会根据<code>doc_count</code>文档总数，降序排序。</p>
<p>ES桶聚合支持两种方式排序：</p>
<ul>
<li><p>内置排序</p>
<p>_count：按文档数排序。对 terms 、 histogram 、 date_histogram 有效。</p>
<p>_term：按词项的字符串值的字母顺序排序，只在 terms 内使用。</p>
<p>_key：按每个桶的键值数值排序, 仅对 histogram 和 date_histogram 有效。</p>
</li>
</ul>
<figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET /cars/_search</span><br><span class="line">{</span><br><span class="line">    "size" : 0,</span><br><span class="line">    "aggs" : {</span><br><span class="line">        "colors" : { // 聚合查询名字，随便取一个</span><br><span class="line">            "terms" : { // 聚合类型为: terms</span><br><span class="line">              "field" : "color", </span><br><span class="line">              "order": { // 设置排序参数</span><br><span class="line">                "_count" : "asc"  // 根据_count排序，asc升序，desc降序</span><br><span class="line">              }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<ul>
<li><p>按度量指标排序</p>
<p>通常情况下，根据桶聚合分桶后，都会对桶内进行多个维度的指标聚合，所以也可以根据桶内指标聚合的结果进行排序。</p>
</li>
</ul>
<figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GET /cars/_search</span><br><span class="line">{</span><br><span class="line">    "size" : 0,</span><br><span class="line">    "aggs" : {</span><br><span class="line">        "colors" : { // 聚合查询名字</span><br><span class="line">            "terms" : { // 聚合类型: terms，先分桶</span><br><span class="line">              "field" : "color", // 分桶字段为color</span><br><span class="line">              "order": { // 设置排序参数</span><br><span class="line">                "avg_price" : "asc"  // 根据avg_price指标聚合结果，升序排序。</span><br><span class="line">              }</span><br><span class="line">            },</span><br><span class="line">            "aggs": { // 嵌套聚合查询，设置桶内聚合指标</span><br><span class="line">                "avg_price": { // 聚合查询名字，前面排序引用的就是这个名字</span><br><span class="line">                    "avg": {"field": "price"} // 计算price字段平均值</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>限制返回桶的数量</strong></p>
<p>如果分桶的数量太多，可以通过给桶聚合增加一个size参数限制返回桶的数量。</p>
<figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /cars/_search</span><br><span class="line">{</span><br><span class="line">    "aggs" : {</span><br><span class="line">        "products" : { // 聚合查询名字</span><br><span class="line">            "terms" : { // 聚合类型为: terms</span><br><span class="line">                "field" : "product", // 根据product字段分桶</span><br><span class="line">                "size" : 5 // 限制最多返回5个桶</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

</body></html>
    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <span class="reward-comment">请作者喝瓶肥宅水🥤</span>
  <button class="reward-btn">
    ￥
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.png" alt="MrDJun WeChat Pay">
      </div>
      <div>
        <img src="/images/alipay.png" alt="MrDJun Alipay">
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>Post author:  </strong>MrDJun
  </li>
  <li class="post-copyright-link">
      <strong>Post link: </strong>
      <a href="https://mrdjun.github.io/p/642dba5b.html" title="Elasticsearch 常用Api">https://mrdjun.github.io/p/642dba5b.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/BY-NC-SA%204.0/4.0/zh-CN" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA 4.0</a> unless stating additionally.
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/Elasticsearch/" rel="tag"># Elasticsearch</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/p/2288491f.html" rel="prev" title="Python Elasticsearch">
                  <i class="fa fa-chevron-left"></i> Python Elasticsearch
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/p/5b400b08.html" rel="next" title="Py3 字符串">
                  Py3 字符串 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
    </main>

    <footer class="footer hidden">
      <div class="footer-inner">

  <div class="busuanzi-count">
  </div>
      </div>
    </footer>

    
  <script src="/js/third-party/anime.min.js"></script>
  <script src="/js/third-party/pjax.min.js"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

    
<script src="/js/third-party/search/search.js"></script>
<script src="/js/third-party/search/local-search.js"></script>





    
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





      <div id="mouse_explode"></div>
      <script src="/js/mo.min.js"></script>
      <script type="text/javascript" src="/js/mouse-explode.js"></script>
    <script type="text/javascript" src="/js/dark-theme.js"></script>
    <script type="text/javascript" src="/js/third-party/zoomify.min.js"></script>
    <script type="text/javascript" src="/js/zoom-img.js"></script>
    <script type="text/javascript" src="/js/encrypt-button.js"></script>
  </body>
</html>
